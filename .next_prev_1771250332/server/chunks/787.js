exports.id=787,exports.ids=[787],exports.modules={42082:(a,b,c)=>{"use strict";c.d(b,{z:()=>h});var d=c(58237);let e={GLM_47:{id:"z-ai/glm4.7",name:"GLM-4.7",supportsReasoning:!0,contextLength:128e3,reasoningConfig:{enable_thinking:!1,clear_thinking:!0}},GLM_47_REASONING:{id:"z-ai/glm4.7",name:"GLM-4.7 Reasoning",supportsReasoning:!0,contextLength:128e3,reasoningConfig:{enable_thinking:!0,clear_thinking:!1}},KIMI_K25:{id:"moonshotai/kimi-k2.5",name:"Kimi K2.5",supportsReasoning:!0,contextLength:256e3,reasoningConfig:{thinking:!1}},KIMI_K25_REASONING:{id:"moonshotai/kimi-k2.5",name:"Kimi K2.5 Reasoning",supportsReasoning:!0,contextLength:256e3,reasoningConfig:{thinking:!0}}};class f{constructor(){this.openRouterClient=(0,d.getOpenRouterClient)(),this.nvidiaApiKey=process.env.NVIDIA_NIM_API_KEY}getModelConfig(a){let b="reasoning"===(a.task??"reasoning")||a.response_format?.type==="json_object";if(a.model){let c=a.model.toLowerCase();if(c.includes("glm"))return b?{id:e.GLM_47_REASONING.id,reasoningConfig:e.GLM_47_REASONING.reasoningConfig}:{id:e.GLM_47.id,reasoningConfig:e.GLM_47.reasoningConfig};if(c.includes("kimi"))return b?{id:e.KIMI_K25_REASONING.id,reasoningConfig:e.KIMI_K25_REASONING.reasoningConfig}:{id:e.KIMI_K25.id,reasoningConfig:e.KIMI_K25.reasoningConfig}}return b?"kimi"===process.env.PREFERRED_REASONING_MODEL?{id:e.KIMI_K25_REASONING.id,reasoningConfig:e.KIMI_K25_REASONING.reasoningConfig}:{id:e.GLM_47_REASONING.id,reasoningConfig:e.GLM_47_REASONING.reasoningConfig}:"glm"===process.env.PREFERRED_FAST_MODEL?{id:e.GLM_47.id,reasoningConfig:e.GLM_47.reasoningConfig}:{id:e.KIMI_K25.id,reasoningConfig:e.KIMI_K25.reasoningConfig}}async nvidiaChatCompletion(a,b=3e4){if(!this.nvidiaApiKey)throw Error("NVIDIA_NIM_API_KEY is not set");let{id:c,reasoningConfig:d}=this.getModelConfig(a);Date.now();let e=a.disableSystemRole?a.messages.map((a,b)=>"system"===a.role?{role:"user",content:`Instruction${b+1}:
${a.content}`}:a):a.messages,f=new AbortController,g=setTimeout(()=>f.abort(),b);try{let b=await fetch("https://integrate.api.nvidia.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${this.nvidiaApiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:c,messages:e,temperature:a.temperature??.7,max_tokens:a.max_tokens??16384,tools:a.tools,response_format:a.response_format,stream:!1,chat_template_kwargs:d}),signal:f.signal});if(clearTimeout(g),!b.ok){let a=await b.text();throw Error(`NVIDIA NIM API error (${b.status}): ${b.statusText} - ${a}`)}let h=await b.json(),i={id:h.id??`nvidia-${Date.now()}`,model:h.model??c,choices:h.choices?.map((a,b)=>({index:b,message:{role:a.message?.role??"assistant",content:a.message?.content??null,reasoning:a.message?.reasoning_content??void 0,tool_calls:a.message?.tool_calls??void 0},finish_reason:a.finish_reason??"stop"}))??[],usage:{prompt_tokens:h.usage?.prompt_tokens??0,completion_tokens:h.usage?.completion_tokens??0,total_tokens:h.usage?.total_tokens??0}};return Date.now(),i}catch(a){throw clearTimeout(g),a}}async openRouterChatCompletion(a,b=3e4){Date.now();let c=await this.openRouterClient.chatCompletion({...a,timeoutMs:b});return Date.now(),c}combineResults(a,b){let c=a.choices[0]?.message?.content||"",d=b.choices[0]?.message?.content||"";return a.choices[0]?.message?.reasoning&&c||c.length>1.5*d.length?a:b}async chatCompletion(a){let b=a.priority??"reasoning",c=a.waitForBoth??!1,d=a.timeoutMs??3e4,e=Date.now();if("fast"===b)try{let b=await this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-mini:free"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}catch(b){try{let b=await this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-large-preview:free"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}catch(c){if(this.nvidiaApiKey){let b=await this.nvidiaChatCompletion(a,d);return{nvidiaResult:b,selectedResult:b,source:"nvidia",executionTimeMs:Date.now()-e}}throw b}}if("standard"===b)try{let b=await this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-large-preview:free"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}catch(b){try{let b=await this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-mini:free"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}catch(c){if(this.nvidiaApiKey){let b=await this.nvidiaChatCompletion(a,d);return{nvidiaResult:b,selectedResult:b,source:"nvidia",executionTimeMs:Date.now()-e}}throw b}}if("reasoning"===b){if(!this.nvidiaApiKey){let b=await this.openRouterChatCompletion({...a,model:"trinity-large"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}try{let b=await this.nvidiaChatCompletion({...a,model:"glm-4.7",task:"reasoning"},d);return{nvidiaResult:b,selectedResult:b,source:"nvidia",executionTimeMs:Date.now()-e}}catch(c){let b=await this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-large-preview:free"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}}if("large-context"===b){if(!this.nvidiaApiKey){let b=await this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-large-preview:free"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}try{let b=await this.nvidiaChatCompletion({...a,model:"kimi",task:"reasoning"},d);return{nvidiaResult:b,selectedResult:b,source:"nvidia",executionTimeMs:Date.now()-e}}catch(c){let b=await this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-large-preview:free"},d);return{openRouterResult:b,selectedResult:b,source:"openrouter",executionTimeMs:Date.now()-e}}}let f=[];if(this.nvidiaApiKey&&f.push(this.nvidiaChatCompletion({...a,model:"glm-4.7",task:"reasoning"},d).then(a=>({source:"nvidia",result:a})).catch(a=>{throw console.error("[ParallelAI] GLM-4.7 failed:",a),a})),f.push(this.openRouterChatCompletion({...a,model:"arcee-ai/trinity-large-preview:free"},d).then(a=>({source:"openrouter",result:a})).catch(a=>{throw console.error("[ParallelAI] OpenRouter failed:",a),a})),c)try{let a=await Promise.all(f),b=a.find(a=>"nvidia"===a.source)?.result,c=a.find(a=>"openrouter"===a.source)?.result;if(b&&c){let a=this.combineResults(b,c);return{nvidiaResult:b,openRouterResult:c,selectedResult:a,source:"combined",executionTimeMs:Date.now()-e}}if(b)return{nvidiaResult:b,selectedResult:b,source:"nvidia",executionTimeMs:Date.now()-e};return{openRouterResult:c,selectedResult:c,source:"openrouter",executionTimeMs:Date.now()-e}}catch(a){throw a}try{let a=await Promise.race(f);if("nvidia"===a.source)return{nvidiaResult:a.result,selectedResult:a.result,source:"nvidia",executionTimeMs:Date.now()-e};return{openRouterResult:a.result,selectedResult:a.result,source:"openrouter",executionTimeMs:Date.now()-e}}catch(b){let a=f.filter(a=>a!==Promise.reject(b));if(a.length>0)try{let b=await a[0];if("nvidia"===b.source)return{nvidiaResult:b.result,selectedResult:b.result,source:"nvidia",executionTimeMs:Date.now()-e};return{openRouterResult:b.result,selectedResult:b.result,source:"openrouter",executionTimeMs:Date.now()-e}}catch(a){}throw b}}async chatCompletionWithSchema(a,b,c=3){let d={...a,priority:"reasoning"},e=null,f=[...a.messages];for(let a=0;a<c;a++)try{let a=b?.type!=="array",c=await this.chatCompletion({...d,messages:f,response_format:a?{type:"json_object"}:void 0});if(!c.selectedResult.choices||0===c.selectedResult.choices.length)throw Error("API returned no choices in response. This may indicate an invalid API key or model.");let e=c.selectedResult.choices[0]?.message,g=("string"==typeof e?.content?e.content.trim():"")||("string"==typeof e?.reasoning?e.reasoning.trim():"");if(!g)throw Error("No content in response");let h=this.parseJsonFromContent(g);if(b?.type==="array"){let a;if(Array.isArray(h))a=h;else if(h&&"object"==typeof h&&Array.isArray(h.resources))a=h.resources;else if(h&&"object"==typeof h&&"type"in h&&"title"in h&&"url"in h)a=[h];else throw Error("Expected an array-like response but received incompatible JSON shape");if(b?.items?.safeParse)return a.map(a=>{let c=b.items.safeParse(a);if(!c.success)throw Error(`Array item validation failed: ${c.error.message}`);return c.data});return a}if(b?.safeParse){let a=b.safeParse(h);if(!a.success)throw Error(a.error.message);return a.data}return h}catch(d){if(e=d,console.error(`Attempt ${a+1} failed:`,d),a<c-1){let a=b?.type==="array"?"Return a JSON ARRAY only.":"Return a JSON OBJECT only.";f.push({role:"user",content:`Your previous response was invalid. Please fix it and provide valid JSON that matches the required schema. Error: ${e.message}

Make sure to:
1. Return ONLY valid JSON (no markdown code blocks)
2. Ensure all strings are properly terminated with quotes
3. Ensure all objects and arrays are properly closed
4. Do not include any text outside the JSON
5. ${a}`})}}throw e||Error("Failed to get valid response")}parseJsonFromContent(a){let b=a,c=a.match(/```(?:json)?\s*([\s\S]*?)```/);c&&(b=c[1]);let d=b.trim();try{return JSON.parse(d)}catch{let a=d.indexOf("{"),b=d.indexOf("["),c=-1===a?b:-1===b?a:Math.min(a,b),e=Math.max(d.lastIndexOf("}"),d.lastIndexOf("]"));if(c>=0&&e>c)return JSON.parse(d.slice(c,e+1));return JSON.parse(d)}}}let g=null;function h(){return g||(g=new f),g}},58237:(a,b,c)=>{"use strict";c.d(b,{getOpenRouterClient:()=>g});let d="https://openrouter.ai/api/v1";class e{constructor(a){this.apiKey=a}async chatCompletion(a){let b=a.model||"arcee-ai/trinity-large-preview:free";Date.now();let c=Math.max(5e3,a.timeoutMs??3e4),e=new AbortController,f=setTimeout(()=>e.abort(),c),g=a.disableSystemRole?a.messages.map((a,b)=>"system"===a.role?{role:"user",content:`Instruction${b+1}:
${a.content}`}:a):a.messages;try{let c=await fetch(`${d}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":process.env.APP_URL||"http://localhost:3000","X-Title":"AI Education System"},body:JSON.stringify({model:b,messages:g,temperature:a.temperature??.7,max_tokens:a.max_tokens,tools:a.tools,response_format:a.response_format,stream:a.stream??!1}),signal:e.signal});if(clearTimeout(f),!c.ok){let a=await c.text();throw Error(`OpenRouter API error (${b}): ${c.statusText} - ${a}`)}let h=await c.json();if(h?.error)throw Error(`OpenRouter provider error (${b}): ${h.error.message||"Unknown error"}${h.error.code?` [code ${h.error.code}]`:""}`);return Date.now(),h}catch(a){throw clearTimeout(f),a}}async chatCompletionWithSchema(a,b,c=3){let d=null,e=[...a.messages];for(let f=0;f<c;f++)try{let c=b?.type!=="array",d=await this.chatCompletion({...a,messages:e,response_format:c?{type:"json_object"}:void 0});if(!d.choices||0===d.choices.length)throw Error("OpenRouter API returned no choices in response. This may indicate an invalid API key or model.");let f=d.choices[0]?.message,g=("string"==typeof f?.content?f.content.trim():"")||("string"==typeof f?.reasoning?f.reasoning.trim():"");if(!g)throw Error("No content in response");let h=this.parseJsonFromContent(g);if(b?.type==="array"){let a;if(Array.isArray(h))a=h;else if(h&&"object"==typeof h&&Array.isArray(h.resources))a=h.resources;else if(h&&"object"==typeof h&&"type"in h&&"title"in h&&"url"in h)a=[h];else throw Error("Expected an array-like response but received incompatible JSON shape");if(b?.items?.safeParse)return a.map(a=>{let c=b.items.safeParse(a);if(!c.success)throw Error(`Array item validation failed: ${c.error.message}`);return c.data});return a}if(b?.safeParse){let a=b.safeParse(h);if(!a.success)throw Error(a.error.message);return a.data}return h}catch(a){if(d=a,console.error(`Attempt ${f+1} failed:`,a),f<c-1){let a=b?.type==="array"?"Return a JSON ARRAY only.":"Return a JSON OBJECT only.";e.push({role:"user",content:`Your previous response was invalid. Please fix it and provide valid JSON that matches the required schema. Error: ${d.message}

Make sure to:
1. Return ONLY valid JSON (no markdown code blocks)
2. Ensure all strings are properly terminated with quotes
3. Ensure all objects and arrays are properly closed
4. Do not include any text outside the JSON
5. ${a}`})}}throw d||Error("Failed to get valid response")}parseJsonFromContent(a){let b=a,c=a.match(/```(?:json)?\s*([\s\S]*?)```/);c&&(b=c[1]);let d=b.trim();try{return JSON.parse(d)}catch{let a=d.indexOf("{"),b=d.indexOf("["),c=-1===a?b:-1===b?a:Math.min(a,b),e=Math.max(d.lastIndexOf("}"),d.lastIndexOf("]"));if(c>=0&&e>c)return JSON.parse(d.slice(c,e+1));return JSON.parse(d)}}async *streamChatCompletion(a){let b=a.model||"arcee-ai/trinity-large-preview:free",c=await fetch(`${d}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json","HTTP-Referer":process.env.APP_URL||"http://localhost:3000","X-Title":"AI Education System"},body:JSON.stringify({model:b,messages:a.messages,temperature:a.temperature??.7,max_tokens:a.max_tokens,stream:!0})});if(!c.ok)throw Error(`OpenRouter API error: ${c.statusText}`);let e=c.body?.getReader();if(!e)throw Error("No response body");let f=new TextDecoder;try{for(;;){let{done:a,value:b}=await e.read();if(a)break;for(let a of f.decode(b).split("\n"))if(a.startsWith("data: ")){let b=a.slice(6);if("[DONE]"===b)continue;try{let a=JSON.parse(b),c=a.choices?.[0]?.delta?.content;c&&(yield c)}catch(a){}}}}finally{e.releaseLock()}}}let f=null;function g(){if(!f){let a=process.env.OPENROUTER_API_KEY;if(!a)throw Error("OPENROUTER_API_KEY is not set");f=new e(a)}return f}},78335:()=>{},96487:()=>{},96798:(a,b,c)=>{"use strict";c.d(b,{z:()=>e});var d=c(96330);let e=globalThis.prismaGlobal??new d.PrismaClient}};